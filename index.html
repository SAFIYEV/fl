<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flappy Circle</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Segoe UI', Arial, sans-serif;
            transition: background-color 0.3s;
        }
        .light-theme {
            background: linear-gradient(180deg, #B3E5FC, #4FC3F7);
        }
        .dark-theme {
            background: linear-gradient(180deg, #212121, #424242);
        }
        #gameCanvas {
            border: 3px solid #333;
            width: 100%;
            height: 100%;
            max-width: 360px;
            max-height: 640px;
            transition: background-color 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .light-theme #gameCanvas {
            background: #E1F5FE;
        }
        .dark-theme #gameCanvas {
            background: #2D2D2D;
        }
        #menu, #shop, #missions {
            position: absolute;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            display: none;
            width: 85%;
            max-width: 340px;
            transition: background-color 0.3s, color 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .light-theme #menu, .light-theme #shop, .light-theme #missions {
            background: rgba(255, 255, 255, 0.97);
            color: #222;
        }
        .dark-theme #menu, .dark-theme #shop, .dark-theme #missions {
            background: rgba(50, 50, 50, 0.97);
            color: #E0E0E0;
        }
        #menu h1, #shop h1, #missions h1 {
            margin: 0 0 20px;
            font-size: 28px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        button {
            padding: 12px 28px;
            margin: 10px;
            cursor: pointer;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            transition: transform 0.2s, background-color 0.3s;
        }
        .light-theme button {
            background: linear-gradient(45deg, #0288D1, #4FC3F7);
            color: #FFFFFF;
        }
        .dark-theme button {
            background: linear-gradient(45deg, #0277BD, #0288D1);
            color: #E0E0E0;
        }
        button:hover {
            transform: scale(1.05);
        }
        .skin {
            display: inline-block;
            margin: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .skin:hover {
            transform: scale(1.1);
        }
        .skin img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .skin.selected img {
            border-color: #FFD700;
        }
        #levelDisplay, #scoreDisplay, #coinsDisplay {
            position: absolute;
            font-size: 18px;
            font-weight: bold;
            transition: color 0.3s;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .light-theme #levelDisplay, .light-theme #scoreDisplay, .light-theme #coinsDisplay {
            color: #FFF;
        }
        .dark-theme #levelDisplay, .dark-theme #scoreDisplay, .dark-theme #coinsDisplay {
            color: #E0E0E0;
        }
        #levelDisplay {
            top: 15px;
            left: 15px;
        }
        #scoreDisplay {
            top: 40px;
            left: 15px;
        }
        #coinsDisplay {
            top: 65px;
            left: 15px;
        }
        #themeToggle, #languageToggle {
            position: absolute;
            padding: 10px 20px;
            font-size: 14px;
        }
        #themeToggle {
            top: 15px;
            right: 15px;
        }
        #languageToggle {
            top: 60px;
            right: 15px;
        }
        #missions ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #missions li {
            margin: 10px 0;
            padding: 12px;
            border-radius: 8px;
            font-size: 15px;
            transition: background-color 0.3s;
        }
        .light-theme #missions li {
            background: #B3E5FC;
        }
        .dark-theme #missions li {
            background: #616161;
        }
        .light-theme #missions li.completed {
            background: #4CAF50;
            color: #FFF;
        }
        .dark-theme #missions li.completed {
            background: #388E3C;
            color: #E0E0E0;
        }
    </style>
</head>
<body class="light-theme">
    <canvas id="gameCanvas" width="360" height="640"></canvas>
    <div id="menu">
        <h1 id="gameTitle">Flappy Circle</h1>
        <button id="startButton" onclick="startGame()">Start Game</button>
        <button id="shopButton" onclick="openShop()">Shop</button>
        <button id="missionsButton" onclick="openMissions()">Missions</button>
    </div>
    <div id="shop">
        <h1 id="shopTitle">Shop</h1>
        <p id="coinsLabel">Coins: <span id="shopCoins">0</span></p>
        <div id="skins"></div>
        <button id="backShopButton" onclick="closeShop()">Back</button>
    </div>
    <div id="missions">
        <h1 id="missionsTitle">Missions</h1>
        <ul id="missionList"></ul>
        <button id="backMissionsButton" onclick="closeMissions()">Back</button>
    </div>
    <div id="levelDisplay">Level: 1</div>
    <div id="scoreDisplay">Score: 0</div>
    <div id="coinsDisplay">Coins: 0</div>
    <button id="themeToggle" onclick="toggleTheme()">Dark Theme</button>
    <button id="languageToggle" onclick="toggleLanguage()">English</button>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const menu = document.getElementById('menu');
        const shop = document.getElementById('shop');
        const missions = document.getElementById('missions');
        const skinsDiv = document.getElementById('skins');
        const missionList = document.getElementById('missionList');
        const shopCoins = document.getElementById('shopCoins');
        const levelDisplay = document.getElementById('levelDisplay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const coinsDisplay = document.getElementById('coinsDisplay');
        const themeToggle = document.getElementById('themeToggle');
        const languageToggle = document.getElementById('languageToggle');

        let player = {
            x: 80,
            y: canvas.height / 2,
            radius: 20,
            velocity: 0,
            gravity: 0.7,
            jump: -13,
            skin: 'skin1',
            scale: 1
        };

        let obstacles = [];
        let coins = [];
        let score = 0;
        let coinsCollected = 0;
        let level = 1;
        let gameSpeed = 4;
        let gameState = 'menu';
        let frame = 0;
        let maxLevel = 50;
        let theme = 'light';
        let language = 'en';

        const skins = [
            { id: 'skin1', src: 'https://via.placeholder.com/50/FF5722', price: 0, owned: true, name: 'Default' },
            { id: 'skin2', src: 'https://via.placeholder.com/50/4CAF50', price: 0, owned: true, name: 'Gift' },
            { id: 'skin3', src: 'https://via.placeholder.com/50/2196F3', price: 1500, owned: false, name: 'Skyward' },
            { id: 'skin4', src: 'https://via.placeholder.com/50/F44336', price: 7500, owned: false, name: 'Crimson' },
            { id: 'skin5', src: 'https://via.placeholder.com/50/FFC107', price: 15000, owned: false, name: 'Aurora' },
            { id: 'skin6', src: 'https://via.placeholder.com/50/9C27B0', price: 75000, owned: false, name: 'Nebula' },
            { id: 'skin7', src: 'https://via.placeholder.com/50/FFD700', price: 1000000, owned: false, name: 'Mythic' }
        ];

        const translations = {
            en: {
                gameTitle: 'Flappy Circle',
                startButton: 'Start Game',
                shopButton: 'Shop',
                missionsButton: 'Missions',
                shopTitle: 'Shop',
                coinsLabel: 'Coins',
                backShopButton: 'Back',
                missionsTitle: 'Missions',
                backMissionsButton: 'Back',
                levelDisplay: 'Level',
                scoreDisplay: 'Score',
                coinsDisplay: 'Coins',
                themeToggleLight: 'Dark Theme',
                themeToggleDark: 'Light Theme',
                missions: [
                    'Reach score 300',
                    'Collect 30 coins',
                    'Complete level 20'
                ],
                reward: 'Reward'
            },
            ru: {
                gameTitle: 'Летающий Круг',
                startButton: 'Начать Игру',
                shopButton: 'Магазин',
                missionsButton: 'Миссии',
                shopTitle: 'Магазин',
                coinsLabel: 'Монеты',
                backShopButton: 'Назад',
                missionsTitle: 'Миссии',
                backMissionsButton: 'Назад',
                levelDisplay: 'Уровень',
                scoreDisplay: 'Очки',
                coinsDisplay: 'Монеты',
                themeToggleLight: 'Темная Тема',
                themeToggleDark: 'Светлая Тема',
                missions: [
                    'Набрать 300 очков',
                    'Собрать 30 монет',
                    'Завершить 20-й уровень'
                ],
                reward: 'Награда'
            },
            ja: {
                gameTitle: 'フラッピーサークル',
                startButton: 'ゲーム開始',
                shopButton: 'ショップ',
                missionsButton: 'ミッション',
                shopTitle: 'ショップ',
                coinsLabel: 'コイン',
                backShopButton: '戻る',
                missionsTitle: 'ミッション',
                backMissionsButton: '戻る',
                levelDisplay: 'レベル',
                scoreDisplay: 'スコア',
                coinsDisplay: 'コイン',
                themeToggleLight: 'ダークテーマ',
                themeToggleDark: 'ライトテーマ',
                missions: [
                    'スコア300を達成',
                    '30コインを集める',
                    'レベル20をクリア'
                ],
                reward: '報酬'
            }
        };

        const missionsData = [
            { id: 1, target: 300, reward: 100, progress: 0, completed: false },
            { id: 2, target: 30, reward: 200, progress: 0, completed: false },
            { id: 3, target: 20, reward: 300, progress: 0, completed: false }
        ];

        function toggleTheme() {
            theme = theme === 'light' ? 'dark' : 'light';
            document.body.className = `${theme}-theme`;
            updateUIText();
        }

        function toggleLanguage() {
            language = language === 'en' ? 'ru' : language === 'ru' ? 'ja' : 'en';
            updateUIText();
        }

        function updateUIText() {
            const t = translations[language];
            document.getElementById('gameTitle').textContent = t.gameTitle;
            document.getElementById('startButton').textContent = t.startButton;
            document.getElementById('shopButton').textContent = t.shopButton;
            document.getElementById('missionsButton').textContent = t.missionsButton;
            document.getElementById('shopTitle').textContent = t.shopTitle;
            document.getElementById('levelDisplay').textContent = `${t.levelDisplay}: ${level}`;
            document.getElementById('scoreDisplay').textContent = `${t.scoreDisplay}: ${score}`;
            document.getElementById('coinsDisplay').textContent = `${t.coinsDisplay}: ${coinsCollected}`;
            document.getElementById('coinsLabel').textContent = `${t.coinsLabel}: `;
            document.getElementById('missionsTitle').textContent = t.missionsTitle;
            document.getElementById('backShopButton').textContent = t.backShopButton;
            document.getElementById('backMissionsButton').textContent = t.backMissionsButton;
            themeToggle.textContent = theme === 'light' ? t.themeToggleLight : t.themeToggleDark;
            languageToggle.textContent = language === 'en' ? 'Русский' : language === 'ru' ? '日本語' : 'English';
            renderMissions();
            renderShop();
        }

        function startGame() {
            gameState = 'playing';
            menu.style.display = 'none';
            player.y = canvas.height / 2;
            player.velocity = 0;
            player.scale = 1;
            obstacles = [];
            coins = [];
            score = 0;
            level = 1;
            gameSpeed = 4;
            frame = 0;
            updateDisplays();
            gameLoop();
        }

        function openShop() {
            gameState = 'shop';
            menu.style.display = 'none';
            shop.style.display = 'block';
            renderShop();
        }

        function closeShop() {
            gameState = 'menu';
            shop.style.display = 'none';
            menu.style.display = 'block';
        }

        function openMissions() {
            gameState = 'missions';
            menu.style.display = 'none';
            missions.style.display = 'block';
            renderMissions();
        }

        function closeMissions() {
            gameState = 'menu';
            missions.style.display = 'none';
            menu.style.display = 'block';
        }

        function renderShop() {
            shopCoins.textContent = coinsCollected;
            skinsDiv.innerHTML = '';
            skins.forEach(skin => {
                const skinDiv = document.createElement('div');
                skinDiv.className = 'skin';
                if (player.skin === skin.id) skinDiv.classList.add('selected');
                const img = document.createElement('img');
                img.src = skin.src;
                img.onerror = () => { img.src = 'https://via.placeholder.com/50/CCCCCC'; }; // Fallback if image fails
                skinDiv.appendChild(img);
                const name = document.createElement('p');
                name.textContent = skin.name;
                skinDiv.appendChild(name);
                if (!skin.owned && skin.price > 0) {
                    const price = document.createElement('p');
                    price.textContent = `${skin.price} ${translations[language].coinsLabel}`;
                    skinDiv.appendChild(price);
                }
                skinDiv.onclick = () => {
                    if (skin.owned) {
                        player.skin = skin.id;
                        renderShop();
                    } else if (coinsCollected >= skin.price) {
                        coinsCollected -= skin.price;
                        skin.owned = true;
                        player.skin = skin.id;
                        renderShop();
                        updateDisplays();
                    }
                };
                skinsDiv.appendChild(skinDiv);
            });
        }

        function renderMissions() {
            missionList.innerHTML = '';
            missionsData.forEach((mission, index) => {
                const li = document.createElement('li');
                li.textContent = `${translations[language].missions[index]} (${mission.progress}/${mission.target}) - ${translations[language].reward}: ${mission.reward} ${translations[language].coinsLabel}`;
                if (mission.completed) li.classList.add('completed');
                missionList.appendChild(li);
            });
        }

        function updateMissions() {
            missionsData.forEach((mission, index) => {
                if (!mission.completed) {
                    if (mission.id === 1 && score >= mission.target) {
                        mission.completed = true;
                        coinsCollected += mission.reward;
                    } else if (mission.id === 2 && coinsCollected >= mission.target) {
                        mission.completed = true;
                        coinsCollected += mission.reward;
                    } else if (mission.id === 3 && level >= mission.target) {
                        mission.completed = true;
                        coinsCollected += mission.reward;
                    }
                    mission.progress = mission.id === 1 ? score : mission.id === 2 ? coinsCollected : level;
                }
            });
        }

        function spawnObstacle() {
            const baseGap = Math.max(110 - level * 2.5, 70);
            const height = Math.random() * (canvas.height - baseGap - 120) + 60;
            const width = 40 + Math.random() * 20 + level * 3;
            obstacles.push({
                x: canvas.width,
                width: width,
                topHeight: height,
                bottomHeight: canvas.height - height - baseGap,
                passed: false
            });
        }

        function spawnCoin() {
            coins.push({
                x: canvas.width,
                y: Math.random() * (canvas.height - 120) + 60,
                radius: 12,
                angle: 0
            });
        }

        function updateDisplays() {
            levelDisplay.textContent = `${translations[language].levelDisplay}: ${level}`;
            scoreDisplay.textContent = `${translations[language].scoreDisplay}: ${score}`;
            coinsDisplay.textContent = `${translations[language].coinsDisplay}: ${coinsCollected}`;
        }

        function gameLoop() {
            if (gameState !== 'playing') return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Player movement
            player.velocity += player.gravity * (1 + level * 0.015);
            player.y += player.velocity;
            if (player.y + player.radius > canvas.height || player.y - player.radius < 0) {
                gameState = 'menu';
                menu.style.display = 'block';
            }

            // Player animation
            if (player.scale > 1) player.scale -= 0.05;
            if (player.scale < 1) player.scale = 1;

            // Draw player
            const skin = skins.find(s => s.id === player.skin);
            const img = new Image();
            img.src = skin.src;
            img.onerror = () => { img.src = 'https://via.placeholder.com/50/CCCCCC'; };
            ctx.save();
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius * player.scale, 0, Math.PI * 2);
            ctx.clip();
            ctx.drawImage(img, player.x - player.radius * player.scale, player.y - player.radius * player.scale, player.radius * 2 * player.scale, player.radius * 2 * player.scale);
            ctx.restore();

            // Obstacles
            const obstacleFrequency = Math.max(70 - level * 2, 40);
            if (frame % obstacleFrequency === 0) spawnObstacle();
            obstacles.forEach(obstacle => {
                obstacle.x -= gameSpeed;
                const gradient = ctx.createLinearGradient(obstacle.x, 0, obstacle.x + obstacle.width, 0);
                gradient.addColorStop(0, theme === 'light' ? '#2E7D32' : '#4CAF50');
                gradient.addColorStop(1, theme === 'light' ? '#4CAF50' : '#66BB6A');
                ctx.fillStyle = gradient;
                ctx.fillRect(obstacle.x, 0, obstacle.width, obstacle.topHeight);
                ctx.fillRect(obstacle.x, canvas.height - obstacle.bottomHeight, obstacle.width, obstacle.bottomHeight);

                // Collision detection
                if (
                    player.x + player.radius * player.scale > obstacle.x &&
                    player.x - player.radius * player.scale < obstacle.x + obstacle.width &&
                    (player.y - player.radius * player.scale < obstacle.topHeight || player.y + player.radius * player.scale > canvas.height - obstacle.bottomHeight)
                ) {
                    gameState = 'menu';
                    menu.style.display = 'block';
                }

                if (obstacle.x + obstacle.width < player.x && !obstacle.passed) {
                    score += 10;
                    obstacle.passed = true;
                    if (score % 80 === 0 && level < maxLevel) {
                        level++;
                        gameSpeed += 0.4;
                    }
                    updateDisplays();
                }
            });
            obstacles = obstacles.filter(obstacle => obstacle.x + obstacle.width > 0);

            // Coins
            const coinFrequency = Math.max(100 - level * 2, 60);
            if (frame % coinFrequency === 0) spawnCoin();
            coins.forEach(coin => {
                coin.x -= gameSpeed;
                coin.angle += 0.1;
                ctx.save();
                ctx.translate(coin.x, coin.y);
                ctx.rotate(coin.angle);
                const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, coin.radius);
                gradient.addColorStop(0, '#FFF176');
                gradient.addColorStop(1, '#FBC02D');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(0, 0, coin.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();

                // Coin collection
                if (
                    Math.hypot(player.x - coin.x, player.y - coin.y) < player.radius * player.scale + coin.radius
                ) {
                    coinsCollected += 2 + Math.floor(level / 5);
                    coins = coins.filter(c => c !== coin);
                    updateDisplays();
                }
            });
            coins = coins.filter(coin => coin.x + coin.radius > 0);

            // Update missions
            updateMissions();

            frame++;
            requestAnimationFrame(gameLoop);
        }

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState === 'playing') {
                player.velocity = player.jump;
                player.scale = 1.2;
            }
        });

        // Initialize
        menu.style.display = 'block';
        updateUIText();
    </script>
</body>
</html>
